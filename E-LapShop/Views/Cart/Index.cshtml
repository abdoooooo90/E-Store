@model IEnumerable<BLL.Models.CartItemDtos.CartItemDto>

@{ 
    ViewData["Title"] = "Cart";
    Layout = "_FurniLayout";
}

<style>
 /* Slightly increase numeric text sizes for better readability */
 .table .price-cell,
 .table .item-total { font-size: 1.1rem; }

 .quantity-amount { font-size: 1.1rem; }

 #cart-subtotal,
 #cart-total,
 #discount-amount { font-size: 1.15rem; }

 /* Complete removal of all spacing between hero and cart table */
 .untree_co-section.before-footer-section { 
     padding-top: 0 !important; 
     margin-top: -20px !important;
 }
 .untree_co-section.before-footer-section .container { 
     padding-top: 0 !important; 
     margin-top: 0 !important;
 }
 .site-blocks-table { 
     margin-top: 0 !important; 
     padding-top: 0 !important; 
 }
 .site-blocks-table .table { 
     margin-top: 0 !important; 
     margin-bottom: 0 !important;
 }
 .hero { 
     margin-bottom: 0 !important; 
     padding-top: 8px !important; 
     padding-bottom: 0 !important; 
 }
 .hero .intro-excerpt { 
     margin-bottom: 0 !important; 
 }
 .hero .intro-excerpt h1 { 
     margin-bottom: 0 !important; 
 }
 .hero .container { 
     padding-bottom: 0 !important; 
     margin-bottom: 0 !important;
 }
 .hero + .untree_co-section { 
     margin-top: 0 !important; 
 }
 .table thead th { 
     padding-top: 0 !important; 
     padding-bottom: 8px !important; 
     position: relative; 
     top: 0; 
     border-top: none !important;
 }
 .table thead {
     border-top: none !important;
 }
 .table {
     border-top: none !important;
 }

 /* Additional spacing removal */
 .row.mb-2.mt-0 {
     margin-top: 0 !important;
     margin-bottom: 0 !important;
 }
 
 /* Force table to stick to hero section */
 .container .row:first-of-type {
     margin-top: 0 !important;
 }
</style>

<!-- Start Hero Section -->
<div class="hero" style="padding-bottom: 0 !important; margin-bottom: 0 !important;">
    <div class="container" style="padding-bottom: 0 !important; margin-bottom: 0 !important;">
        <div class="row justify-content-between" style="margin-bottom: 0 !important;">
            <div class="col-lg-5">
                <div class="intro-excerpt" style="margin-bottom: 0 !important;">
                    <h1 style="margin-bottom: 0 !important;">Cart</h1>
                </div>
            </div>
            @if (Model != null && Model.Any())
            {
                <div class="col-lg-7">
                    <div class="hero-img-wrap">
                        <img src="~/furni/images/couch.png" class="img-fluid">
                    </div>
                </div>
            }
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section before-footer-section" style="padding-top: 0 !important; margin-top: -30px !important;">
    <div class="container" style="padding-top: 0 !important; margin-top: 0 !important;">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (Model != null && Model.Any())
        {
            <div class="row mb-2 mt-0">
                <form class="col-md-12" method="post">
                    <div class="site-blocks-table">
                        <table class="table">
                            <thead>
                                <tr style="border-bottom: 2px solid #ddd;">
                                    <th class="product-thumbnail" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Image</th>
                                    <th class="product-name" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Product</th>
                                    <th class="product-price" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Price</th>
                                    <th class="product-quantity" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Quantity</th>
                                    <th class="product-total" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Total</th>
                                    <th class="product-remove" style="padding-top: 2px; padding-bottom: 5px; vertical-align: bottom;">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td class="product-thumbnail">
                                            <img src="@(!string.IsNullOrEmpty(item.ProductImageUrl) ? item.ProductImageUrl : "~/furni/images/product-1.png")" 
                                                 alt="@item.ProductName" class="img-fluid" style="width: 80px; height: 80px; object-fit: cover;">
                                        </td>
                                        <td class="product-name">
                                            <h2 class="h5 text-black">@item.ProductName</h2>
                                            @if (item.ProductStock <= 0)
                                            {
                                                <span class="text-danger fw-bold" style="font-size: 0.9rem;">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Currently Unavailable
                                                </span>
                                            }
                                        </td>
                                        <td class="price-cell">@item.ProductPrice.ToString("F2") EGP</td>
                                        <td>
                                            <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;">
                                                <div class="input-group-prepend">
                                                    <button class="btn btn-outline-black" type="button" onclick="updateQuantity(@item.Id, (parseInt(this.closest('tr').querySelector('.quantity-amount').value) || @item.Quantity) - 1)">&minus;</button>
                                                </div>
                                                <input type="text" class="form-control text-center quantity-amount" value="@item.Quantity" 
                                                       placeholder="" aria-label="Example text with button addon" 
                                                       aria-describedby="button-addon1" readonly data-max-stock="@item.ProductStock">
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-black" type="button" 
                                                            onclick="checkStockAndUpdate(@item.Id, (parseInt(this.closest('tr').querySelector('.quantity-amount').value) || @item.Quantity) + 1, @item.ProductStock)">&plus;</button>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="item-total">@((item.ProductPrice * item.Quantity).ToString("F2")) EGP</td>
                                        <td>
                                            <button type="button" class="btn btn-outline-danger btn-sm" title="Remove item" onclick="removeFromCart(@item.Id)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button class="btn btn-black btn-sm btn-block" onclick="updateCart()">Update Cart</button>
                        </div>
                        <div class="col-md-6">
                            <a href="@Url.Action("Shop", "Furni")" class="btn btn-outline-black btn-sm btn-block">Continue Shopping</a>
                        </div>
                    </div>
                    
                    <!-- Coupon Section -->
                    <div class="row mb-5">
                        <div class="col-md-12">
                            <div class="coupon-section p-4" style="background-color: #f8f9fa; border-radius: 8px;">
                                <h4 class="mb-3 text-dark fw-bold">Coupon</h4>
                                
                                <div class="d-flex gap-3">
                                    <input type="text" class="form-control" id="coupon-code" 
                                           placeholder="Coupon Code" 
                                           style="border: 1px solid #dee2e6; border-radius: 25px; padding: 12px 20px; flex: 1;">
                                    <button class="btn px-4 py-2" type="button" onclick="applyCoupon()" 
                                            style="background-color: #2f2f2f; color: white; border-radius: 25px; white-space: nowrap; border: none;">
                                        Apply Coupon
                                    </button>
                                </div>
                                
                                <div id="coupon-message" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 pl-5">
                    <div class="row justify-content-end">
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-md-12 text-right border-bottom mb-5">
                                    <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <span class="text-black">Subtotal</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black" id="cart-subtotal">@Model.Sum(x => x.Total).ToString("F2") EGP</strong>
                                </div>
                            </div>

                            <div class="row mb-3" id="discount-row" style="display: none;">
                                <div class="col-md-6">
                                    <span class="text-black">Discount</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-success" id="discount-amount">-0.00 EGP</strong>
                                </div>
                            </div>

                            <div class="row mb-5">
                                <div class="col-md-6">
                                    <span class="text-black">Total</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black" id="cart-total">@Model.Sum(x => x.Total).ToString("F2") EGP</strong>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <a href="@Url.Action("Checkout", "Cart")" class="btn btn-black btn-lg py-3 btn-block">Proceed To Checkout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-shopping-cart fa-5x text-muted"></i>
                </div>
                <h3 class="text-muted mb-3">Your cart is empty</h3>
                <p class="text-muted mb-4">Looks like you haven't added anything to your cart yet.</p>
                <a href="@Url.Action("Shop", "Furni")" class="btn btn-primary btn-lg">
                    <i class="fas fa-shopping-bag me-2"></i>
                    Start Shopping
                </a>
            </div>
        }
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Simple, reliable cart actions (original working pattern)
function updateQuantity(cartItemId, newQuantity) {
    if (newQuantity < 1) {
        removeFromCart(cartItemId);
        return;
    }
    $.ajax({
        url: '/Cart/UpdateQuantity',
        type: 'POST',
        data: { id: cartItemId, quantity: newQuantity },
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function (response) {
            console.log('UpdateQuantity Response:', response);
            if (response.success) {
                if (typeof updateCartCount === 'function') { try { updateCartCount(); } catch (_) {} }
                location.reload();
            } else {
                alert(response.message || 'Error updating cart');
                // If there's a max quantity, revert the input to that value
                if (response.maxQuantity) {
                    var quantityInput = $('tr').find('[onclick*="' + cartItemId + '"]').closest('tr').find('.quantity-amount');
                    quantityInput.val(response.maxQuantity);
                }
            }
        },
        error: function () { alert('Error updating cart'); }
    });
}

function removeFromCart(cartItemId) {
    if (!confirm('Are you sure you want to remove this item from your cart?')) return;
    $.ajax({
        url: '/Cart/Remove',
        type: 'POST',
        data: { id: cartItemId },
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function (response) {
            if (response.success) {
                if (typeof updateCartCount === 'function') { try { updateCartCount(); } catch (_) {} }
                location.reload();
            } else {
                alert('Error removing item: ' + (response.message || ''));
            }
        },
        error: function () { alert('Error removing item from cart'); }
    });
}

function updateCart() { location.reload(); }

function checkStockAndUpdate(cartItemId, newQuantity, maxStock) {
    if (newQuantity > maxStock) {
        alert(`Cannot add more items. Only ${maxStock} items available in stock.`);
        return;
    }
    updateQuantity(cartItemId, newQuantity);
}

function applyCoupon() {
    var couponCode = $('#coupon-code').val().trim();
    if (!couponCode) { alert('Please enter a coupon code'); return; }
    $.ajax({
        url: '@Url.Action("ApplyCoupon", "Cart")',
        type: 'POST',
        data: { couponCode: couponCode },
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function (response) {
            if (response.success) {
                $('#discount-amount').text('-' + parseFloat(response.discountAmount).toFixed(2) + ' EGP');
                $('#discount-row').show();
                $('#cart-total').text(parseFloat(response.newTotal).toFixed(2) + ' EGP');
            } else {
                // Hide discount row for invalid coupons
                $('#discount-row').hide();
                $('#cart-total').text($('#cart-subtotal').text());
                alert(response.message || 'Invalid coupon code');
            }
        },
        error: function () { 
            // Hide discount row on error
            $('#discount-row').hide();
            $('#cart-total').text($('#cart-subtotal').text());
            alert('An error occurred while applying the coupon'); 
        }
    });
}
</script>
