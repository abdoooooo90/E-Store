@{
    ViewBag.Title = "Checkout";
    Layout = "~/Views/Shared/_FurniLayout.cshtml";
}

<!-- Start Hero Section -->
<div class="hero">
    <div class="container">
        <div class="row justify-content-between">
            <div class="col-lg-5">
                <div class="intro-excerpt">
                    <h1>Checkout</h1>
                </div>
            </div>
            <div class="col-lg-7">
            </div>
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section before-footer-section">
    <div class="container">
        <!-- Returning customer login link -->
        <div class="row mb-4">
            <div class="col-12">
                <p class="text-muted">Returning customer? <a href="#" class="text-decoration-underline">Click here to login</a></p>
            </div>
        </div>
    
        <form asp-controller="Cart" asp-action="PlaceOrder" method="post" id="checkoutForm">
            <div class="row">
                <!-- Billing Details -->
                <div class="col-lg-7">
                    <div class="mb-5">
                        <h3 class="h4 text-black mb-4">Billing Details</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="text-black">Full Name <span class="text-danger">*</span></label>
                                <input name="FullName" type="text" class="form-control" placeholder="Enter your full name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="text-black">Phone Number <span class="text-danger">*</span></label>
                                <input name="Phone" type="tel" class="form-control" placeholder="Enter your phone number" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="text-black">Email Address <span class="text-danger">*</span></label>
                                <input name="Email" type="email" class="form-control" placeholder="Enter your email address" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="text-black">Delivery Address <span class="text-danger">*</span></label>
                                <textarea name="shippingAddress" class="form-control" rows="3" placeholder="Enter your complete delivery address" required></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="text-black">City <span class="text-danger">*</span></label>
                                <input name="City" type="text" class="form-control" placeholder="Enter your city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="text-black">Country <span class="text-danger">*</span></label>
                                <select name="Country" class="form-control" required>
                                    <option value="">Select Country</option>
                                    <option value="EG" selected>Egypt</option>
                                    <option value="SA">Saudi Arabia</option>
                                    <option value="AE">UAE</option>
                                    <option value="US">United States</option>
                                    <option value="UK">United Kingdom</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <label class="text-black">Order Notes (Optional)</label>
                                <textarea name="Notes" class="form-control" rows="3" placeholder="Any special instructions for your order..."></textarea>
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="mb-5">
                            <h3 class="h4 text-black mb-4">Payment Method</h3>
                            <div class="payment-methods">
                                <div class="payment-option mb-3 p-3 border rounded" data-payment="cash">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="CashOnDelivery" checked>
                                        <label class="form-check-label d-flex align-items-center" for="cashOnDelivery">
                                            <i class="fas fa-money-bill-wave text-success me-2"></i>
                                            <div>
                                                <strong>Cash on Delivery</strong>
                                                <small class="d-block text-muted">Pay when you receive your order</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="payment-option mb-3 p-3 border rounded" data-payment="card">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="CreditCard">
                                        <label class="form-check-label d-flex align-items-center" for="creditCard">
                                            <i class="fas fa-credit-card text-primary me-2"></i>
                                            <div>
                                                <strong>Credit/Debit Card</strong>
                                                <small class="d-block text-muted">Pay securely with your card</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- Credit Card Details -->
                                    <div id="creditCardDetails" class="mt-3" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label class="text-black">Card Number <span class="text-danger">*</span></label>
                                                <input type="text" id="cardNumber" name="CardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="text-black">Expiry Date <span class="text-danger">*</span></label>
                                                <input type="text" id="expiryDate" name="ExpiryDate" class="form-control" placeholder="MM/YY" maxlength="5">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="text-black">CVV <span class="text-danger">*</span></label>
                                                <input type="text" id="cvv" name="CVV" class="form-control" placeholder="123" maxlength="4">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label class="text-black">Cardholder Name <span class="text-danger">*</span></label>
                                                <input type="text" id="cardHolderName" name="CardHolderName" class="form-control" placeholder="Name as on card">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="payment-option mb-3 p-3 border rounded" data-payment="bank">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="BankTransfer">
                                        <label class="form-check-label d-flex align-items-center" for="bankTransfer">
                                            <i class="fas fa-university text-info me-2"></i>
                                            <div>
                                                <strong>Bank Transfer</strong>
                                                <small class="d-block text-muted">Transfer directly to our bank account</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- Bank Transfer Details -->
                                    <div id="bankTransferDetails" class="mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle"></i> Bank Transfer Instructions</h6>
                                            <p class="mb-2"><strong>Bank Name:</strong> Furni Store Bank</p>
                                            <p class="mb-2"><strong>Account Number:</strong> 1234567890</p>
                                            <p class="mb-2"><strong>IBAN:</strong> EG380019000100000001234567890</p>
                                            <p class="mb-2"><strong>Swift Code:</strong> FURNIEGCX</p>
                                            <p class="mb-0"><small>Please use your order number as reference when making the transfer.</small></p>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label class="text-black">Transfer Reference Number <span class="text-danger">*</span></label>
                                                <input type="text" name="TransferReference" class="form-control" placeholder="Enter your transfer reference number">
                                                <small class="text-muted">Enter the reference number from your bank transfer receipt</small>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label class="text-black">Transfer Date <span class="text-danger">*</span></label>
                                                <input type="date" name="TransferDate" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Your Order -->
                <div class="col-lg-5">

                    <!-- Your Order -->
                    <div class="mb-5">
                        <h3 class="h4 text-black mb-4">Your Order</h3>
                        <div class="p-3 p-lg-5 border">
                            <table class="table site-block-order-table mb-5">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (ViewBag.CartItems != null)
                                    {
                                        @foreach (var item in (IEnumerable<BLL.Models.CartItemDtos.CartItemDto>)ViewBag.CartItems)
                                        {
                                            <tr>
                                                <td>@item.ProductName <strong class="mx-2">x</strong> @item.Quantity</td>
                                                <td>@((item.ProductPrice * item.Quantity).ToString("F2")) EGP</td>
                                            </tr>
                                        }
                                    }
                                    <tr>
                                        <td class="text-black font-weight-bold"><strong>Cart Subtotal</strong></td>
                                        <td class="text-black">@ViewBag.CartTotal.ToString("F2") EGP</td>
                                    </tr>
                                    <tr>
                                        <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                                        <td class="text-black font-weight-bold"><strong>@ViewBag.CartTotal.ToString("F2") EGP</strong></td>
                                    </tr>
                                </tbody>
                            </table>


                            <div class="form-group">
                                <button class="btn btn-black btn-lg py-3 btn-block" type="submit">Place Order</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Payment method selection visual feedback and show/hide details
            $('.payment-option').on('click', function() {
                $('.payment-option').removeClass('border-primary bg-light');
                $(this).addClass('border-primary bg-light');
                $(this).find('input[type="radio"]').prop('checked', true);
                
                // Hide all payment details
                $('#creditCardDetails, #bankTransferDetails').hide();
                
                // Show relevant payment details
                let selectedPayment = $(this).find('input[type="radio"]').val();
                if (selectedPayment === 'CreditCard') {
                    $('#creditCardDetails').slideDown();
                    // Make credit card fields required
                    $('#creditCardDetails input').prop('required', true);
                    $('#bankTransferDetails input').prop('required', false);
                } else if (selectedPayment === 'BankTransfer') {
                    $('#bankTransferDetails').slideDown();
                    // Make bank transfer fields required
                    $('#bankTransferDetails input').prop('required', true);
                    $('#creditCardDetails input').prop('required', false);
                } else {
                    // Cash on delivery - no additional fields required
                    $('#creditCardDetails input, #bankTransferDetails input').prop('required', false);
                }
            });

            // Initialize first payment option as selected
            $('.payment-option:first').addClass('border-primary bg-light');
            
            // Card number formatting
            $('#cardNumber').on('input', function() {
                let value = $(this).val().replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                $(this).val(formattedValue);
            });

            // Expiry date formatting
            $('#expiryDate').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                $(this).val(value);
            });

            // CVV validation
            $('#cvv').on('input', function() {
                $(this).val($(this).val().replace(/[^0-9]/g, ''));
            });

            // Form validation and submission
            $('#checkoutForm').on('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                let isValid = true;
                let requiredFields = ['FullName', 'Phone', 'Email', 'shippingAddress', 'City'];
                
                // Get selected payment method
                let selectedPayment = $('input[name="paymentMethod"]:checked').val();
                
                // Add payment-specific required fields
                if (selectedPayment === 'CreditCard') {
                    requiredFields.push('CardNumber', 'ExpiryDate', 'CVV', 'CardHolderName');
                } else if (selectedPayment === 'BankTransfer') {
                    requiredFields.push('TransferReference', 'TransferDate');
                }
                
                requiredFields.forEach(function(field) {
                    let input = $(`[name="${field}"], #${field}`);
                    if (!input.val().trim()) {
                        input.addClass('is-invalid');
                        isValid = false;
                    } else {
                        input.removeClass('is-invalid');
                    }
                });

                // Additional credit card validation
                if (selectedPayment === 'CreditCard') {
                    let cardNumber = $('#cardNumber').val().replace(/\s/g, '');
                    let expiryDate = $('#expiryDate').val();
                    let cvv = $('#cvv').val();

                    if (cardNumber.length < 13 || cardNumber.length > 19) {
                        $('#cardNumber').addClass('is-invalid');
                        isValid = false;
                    }
                    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
                        $('#expiryDate').addClass('is-invalid');
                        isValid = false;
                    }
                    if (cvv.length < 3 || cvv.length > 4) {
                        $('#cvv').addClass('is-invalid');
                        isValid = false;
                    }
                }

                if (!isValid) {
                    alert('Please fill in all required fields correctly');
                    return;
                }

                // Show loading state
                $('button[type="submit"]').html('<i class="fas fa-spinner fa-spin"></i> Processing Order...').prop('disabled', true);

                // Prepare form data
                let formData = {
                    shippingAddress: $('textarea[name="shippingAddress"]').val(),
                    paymentMethod: selectedPayment
                };

                // Add payment-specific data
                if (selectedPayment === 'CreditCard') {
                    formData.cardNumber = $('#cardNumber').val();
                    formData.expiryDate = $('#expiryDate').val();
                    formData.cvv = $('#cvv').val();
                    formData.cardHolderName = $('#cardHolderName').val();
                } else if (selectedPayment === 'BankTransfer') {
                    formData.transferReference = $('[name="TransferReference"]').val();
                    formData.transferDate = $('[name="TransferDate"]').val();
                }

                // Submit order via AJAX
                $.ajax({
                    url: '@Url.Action("PlaceOrder", "Cart")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            let message = 'Order placed successfully! Order ID: ' + response.orderId;
                            if (selectedPayment === 'BankTransfer') {
                                message += '\n\nPlease complete your bank transfer using the provided details and reference your order ID.';
                            }
                            alert(message);
                            window.location.href = '@Url.Action("OrderConfirmation", "Cart")/' + response.orderId;
                        } else {
                            alert('Error: ' + response.message);
                            $('button[type="submit"]').html('Place Order').prop('disabled', false);
                        }
                    },
                    error: function() {
                        alert('An error occurred while placing the order. Please try again.');
                        $('button[type="submit"]').html('Place Order').prop('disabled', false);
                    }
                });
            });

            // Remove validation error on input
            $('input, textarea, select').on('input change', function() {
                $(this).removeClass('is-invalid');
            });
        });

    </script>

    <style>
        .payment-option {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-option:hover {
            border-color: #3b5d50 !important;
            background-color: #f8f9fa;
        }
        
        .payment-option.border-primary {
            border-color: #3b5d50 !important;
            background-color: #f0f8f0;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
        }
        
        .form-check-input:checked {
            background-color: #3b5d50;
            border-color: #3b5d50;
        }
    </style>
}
