@using BLL.Models.ProductDtos
@model ProductDto
@{
    ViewData["Title"] = $"{Model.Name} - Furni";
    Layout = "~/Views/Shared/_FurniLayout.cshtml";
}

<!-- Start Hero Section -->
<div class="hero">
    <div class="container">
        <div class="row justify-content-between">
            <div class="col-lg-5">
                <div class="intro-excerpt">
                    <h1>@Model.Name</h1>
                    <p class="mb-4">@Model.Description</p>
                </div>
            </div>
            <div class="col-lg-7">
            </div>
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section product-section before-footer-section">
    <div class="container">
        <div class="row">
            <div class="col-md-6 mb-5 mb-md-0">
                <div class="product-image-gallery">
                    <div class="main-image mb-3">
                        <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded shadow-sm" id="mainProductImage">
                    </div>
                    <div class="thumbnail-images">
                        <div class="row">
                            <div class="col-12">
                                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded thumbnail-img active" onclick="changeMainImage(this.src)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="product-details">
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Furni")">Home</a></li>
                            <li class="breadcrumb-item"><a href="@Url.Action("Shop", "Furni")">Shop</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
                        </ol>
                    </nav>

                    <h1 class="product-title h2 mb-3">@Model.Name</h1>
                    
                    <div class="product-rating mb-3">
                        <div class="stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="fas fa-star text-warning"></i>
                            }
                        </div>
                        <span class="rating-text ms-2">(4.5) • 24 reviews</span>
                    </div>

                    <div class="product-price mb-4">
                        <span class="current-price h3 fw-bold" style="color: #3b5d50;">@Model.Price.ToString("F2") EGP</span>
                        <span class="original-price text-muted text-decoration-line-through ms-2">@((Model.Price * 1.2m).ToString("F2")) EGP</span>
                        <span class="discount-badge badge ms-2" style="background-color: #3b5d50; color: white;">20% OFF</span>
                    </div>

                    <div class="product-description mb-4">
                        <p class="text-muted">@Model.Description</p>
                    </div>

                    <div class="product-info mb-4">
                        <div class="row">
                            <div class="col-6">
                                <strong>Category:</strong> @Model.CategoryName
                            </div>
                            <div class="col-6">
                                <strong>Availability:</strong> 
                                @if (Model.Stock > 0)
                                {
                                    <span class="text-success">In Stock (@Model.Stock available)</span>
                                }
                                else
                                {
                                    <span class="text-danger">Out of Stock</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="product-options mb-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="color" class="form-label"><strong>Color:</strong></label>
                                <select class="form-select" id="color">
                                    <option value="natural">Natural Wood</option>
                                    <option value="black">Black</option>
                                    <option value="white">White</option>
                                    <option value="brown">Brown</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="quantity" class="form-label"><strong>Quantity:</strong></label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">-</button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="@Model.Stock">
                                    <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="product-actions mb-4">
                        <div class="row">
                            <div class="col-12 mb-3">
                                @if (Model.IsAvailable && Model.Stock > 0)
                                {
                                    @if (User.Identity?.IsAuthenticated == true)
                                    {
                                        <button class="btn btn-lg w-100 add-to-cart-btn" data-product-id="@Model.Id" style="background-color: #3b5d50; color: white; border: none;">
                                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                        </button>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("Auth", "Account")" class="btn btn-lg w-100" style="background-color: #3b5d50; color: white; border: none;">
                                            <i class="fas fa-shopping-cart me-2"></i>Login to Add to Cart
                                        </a>
                                    }
                                }
                                else
                                {
                                    <button class="btn btn-lg w-100" disabled style="background-color: #6c757d; color: white; border: none;">
                                        <i class="fas fa-clock me-2"></i>Currently Unavailable - Available Soon
                                    </button>
                                }
                            </div>
                            <div class="col-12 mb-3">
                                @if (User.Identity?.IsAuthenticated == true)
                                {
                                    <button class="btn btn-lg w-100 wishlist-btn" data-product-id="@Model.Id" style="background-color: #f9bf29; color: #2f2f2f; border: none;">
                                        <i class="fas fa-heart me-2" style="color: #ccc;"></i>Add to Wishlist
                                    </button>
                                }
                                else
                                {
                                    <a href="@Url.Action("Auth", "Account")" class="btn btn-lg w-100" style="background-color: #f9bf29; color: #2f2f2f; border: none;">
                                        <i class="fas fa-heart me-2"></i>Login to Add to Wishlist
                                    </a>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="product-features">
                        <div class="row">
                            <div class="col-6 col-md-3 text-center mb-3">
                                <div class="feature-icon mb-2">
                                    <img src="~/furni/images/truck.svg" alt="Free Shipping" class="img-fluid" style="width: 30px;">
                                </div>
                                <small class="text-muted">Free Shipping</small>
                            </div>
                            <div class="col-6 col-md-3 text-center mb-3">
                                <div class="feature-icon mb-2">
                                    <img src="~/furni/images/return.svg" alt="Easy Returns" class="img-fluid" style="width: 30px;">
                                </div>
                                <small class="text-muted">Easy Returns</small>
                            </div>
                            <div class="col-6 col-md-3 text-center mb-3">
                                <div class="feature-icon mb-2">
                                    <img src="~/furni/images/support.svg" alt="24/7 Support" class="img-fluid" style="width: 30px;">
                                </div>
                                <small class="text-muted">24/7 Support</small>
                            </div>
                            <div class="col-6 col-md-3 text-center mb-3">
                                <div class="feature-icon mb-2">
                                    <i class="fas fa-shield-alt text-success" style="font-size: 30px;"></i>
                                </div>
                                <small class="text-muted">Secure Payment</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">Description</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab">Specifications</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews (24)</button>
                    </li>
                </ul>
                <div class="tab-content mt-4" id="productTabsContent">
                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Product Description</h5>
                                <p>@Model.Description</p>
                                <p>This premium furniture piece combines modern design with exceptional comfort. Crafted from high-quality materials, it's built to last while maintaining its elegant appearance.</p>
                                <ul>
                                    <li>Premium quality materials</li>
                                    <li>Modern ergonomic design</li>
                                    <li>Easy assembly with included tools</li>
                                    <li>Suitable for home and office use</li>
                                    <li>Available in multiple colors</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded">
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="specifications" role="tabpanel">
                        <h5>Technical Specifications</h5>
                        <table class="table table-striped">
                            <tbody>
                                <tr><td><strong>Dimensions</strong></td><td>75cm x 65cm x 85cm</td></tr>
                                <tr><td><strong>Weight</strong></td><td>12 kg</td></tr>
                                <tr><td><strong>Material</strong></td><td>Premium Wood & Metal</td></tr>
                                <tr><td><strong>Color Options</strong></td><td>Natural, Black, White, Brown</td></tr>
                                <tr><td><strong>Assembly Required</strong></td><td>Yes (30-45 minutes)</td></tr>
                                <tr><td><strong>Warranty</strong></td><td>2 Years</td></tr>
                                <tr><td><strong>Care Instructions</strong></td><td>Wipe with damp cloth</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="reviews-section">
                            <div class="review-summary mb-4">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="average-rating">
                                            <span class="rating-number h2">4.5</span>
                                            <div class="stars mb-2">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fas fa-star text-warning"></i>
                                                }
                                            </div>
                                            <p class="text-muted">Based on 24 reviews</p>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="rating-breakdown">
                                                <div class="rating-bar mb-2">
                                                    <span>5 stars</span>
                                                <div class="progress mx-3" style="height: 10px;">
                                                    <div class="progress-bar bg-warning" style="width: 70%"></div>
                                                </div>
                                                <span>70%</span>
                                            </div>
                                            <div class="rating-bar mb-2">
                                                <span>4 stars</span>
                                                <div class="progress mx-3" style="height: 10px;">
                                                    <div class="progress-bar bg-warning" style="width: 20%"></div>
                                                </div>
                                                <span>20%</span>
                                            </div>
                                            <div class="rating-bar mb-2">
                                                <span>3 stars</span>
                                                <div class="progress mx-3" style="height: 10px;">
                                                    <div class="progress-bar bg-warning" style="width: 7%"></div>
                                                </div>
                                                <span>7%</span>
                                            </div>
                                            <div class="rating-bar mb-2">
                                                <span>2 stars</span>
                                                <div class="progress mx-3" style="height: 10px;">
                                                    <div class="progress-bar bg-warning" style="width: 2%"></div>
                                                </div>
                                                <span>2%</span>
                                            </div>
                                            <div class="rating-bar mb-2">
                                                <span>1 star</span>
                                                <div class="progress mx-3" style="height: 10px;">
                                                    <div class="progress-bar bg-warning" style="width: 1%"></div>
                                                </div>
                                                <span>1%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="individual-reviews">
                                <div class="review-item border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>Sarah Johnson</strong>
                                            <div class="stars">
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                    <p>Excellent quality chair! Very comfortable and looks great in my home office. Assembly was straightforward and the instructions were clear.</p>
                                </div>

                                <div class="review-item border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>Mike Chen</strong>
                                            <div class="stars">
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="far fa-star text-warning"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">1 week ago</small>
                                    </div>
                                    <p>Good value for money. The chair is sturdy and comfortable. Only minor complaint is that it took a bit longer to assemble than expected.</p>
                                </div>

                                <div class="review-item">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>Emma Wilson</strong>
                                            <div class="stars">
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                                <i class="fas fa-star text-warning"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted">2 weeks ago</small>
                                    </div>
                                    <p>Love this chair! Perfect for my dining room. The design is modern and elegant, and it's very comfortable to sit in for long periods.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        @if (ViewBag.RelatedProducts != null && ((List<BLL.Models.ProductDtos.ProductDto>)ViewBag.RelatedProducts).Any())
        {
            <div class="row">
                <div class="col-12">
                    <h3 class="mb-4">Related Products</h3>
                </div>
                <div class="col-12">
                    <div class="row">
                        @foreach (var relatedProduct in (List<BLL.Models.ProductDtos.ProductDto>)ViewBag.RelatedProducts)
                        {
                            <div class="col-12 col-md-4 col-lg-3 mb-4">
                                <div class="product-item-wrapper position-relative">
                                    @if (User.Identity?.IsAuthenticated == true)
                                    {
                                        <button class="btn btn-link position-absolute wishlist-btn-related" 
                                                data-product-id="@relatedProduct.Id" 
                                                style="top: 10px; right: 10px; z-index: 10; background: rgba(255,255,255,0.9); border-radius: 50%; width: 40px; height: 40px; padding: 0;">
                                            <i class="fas fa-heart text-muted wishlist-icon" style="font-size: 1.2rem;"></i>
                                        </button>
                                    }
                                    
                                    <a class="product-item" href="@Url.Action("ProductDetails", "Furni", new { id = relatedProduct.Id })">
                                        <img src="@relatedProduct.ImageUrl" class="img-fluid product-thumbnail">
                                        <h3 class="product-title">@relatedProduct.Name</h3>
                                        <strong class="product-price">@relatedProduct.Price.ToString("F2") EGP</strong>
                                        <span class="icon-cross">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
.thumbnail-img {
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
}

.thumbnail-img:hover,
.thumbnail-img.active {
    border-color: #3b5d50;
}

.product-title {
    color: #2f2f2f;
}

.breadcrumb-item a {
    color: #3b5d50;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

.rating-bar {
    display: flex;
    align-items: center;
    font-size: 14px;
}

.rating-bar span:first-child {
    width: 60px;
}

.rating-bar span:last-child {
    width: 40px;
    text-align: right;
}

.review-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.discount-badge {
    font-size: 12px;
}

.product-actions .btn {
    border-radius: 8px;
}

.nav-tabs .nav-link {
    color: #3b5d50;
    border: none;
    border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
    background: none;
    border-bottom-color: #3b5d50;
    color: #3b5d50;
}

.product-item-wrapper:hover .wishlist-btn-related {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

.wishlist-btn-related:hover {
    background: rgba(255,255,255,1) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.wishlist-icon.text-danger {
    color: #dc3545 !important;
}

.wishlist-icon.text-muted {
    color: #6c757d !important;
}
</style>

<script>
function changeMainImage(src) {
    document.getElementById('mainProductImage').src = src;
    
    // Update active thumbnail
    document.querySelectorAll('.thumbnail-img').forEach(img => {
        img.classList.remove('active');
    });
    event.target.classList.add('active');
}

function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value);
    if (currentValue < 10) {
        quantityInput.value = currentValue + 1;
    }
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
    }
}

function viewProductDetails() {
    // Scroll to product details tabs
    document.getElementById('productTabs').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function contactSeller() {
    // Redirect to contact page
    window.location.href = '@Url.Action("Contact", "Furni")';
}

// Wishlist and Cart functionality
$(document).ready(function() {
    // Load wishlist status on page load
    loadWishlistStatus();
    updateWishlistCount();
    updateCartCount();

    // Wishlist functionality
    $('.wishlist-btn').on('click', function(e) {
        e.preventDefault();
        
        const productId = $(this).data('product-id');
        const heartIcon = $(this).find('i');
        const isInWishlist = heartIcon.hasClass('text-danger');
        
        if (isInWishlist) {
            // Remove from wishlist
            $.post('@Url.Action("RemoveFromWishlist", "Wishlist")', { productId: productId })
                .done(function(response) {
                    if (response.success) {
                        heartIcon.removeClass('text-danger').css('color', '#ccc');
                        $(this).html('<i class="fas fa-heart me-2" style="color: #ccc;"></i>Add to Wishlist');
                        showToast('تم إزالة المنتج من قائمة الأمنيات', 'success');
                        updateWishlistCount();
                    } else {
                        showToast('خطأ في إزالة المنتج من قائمة الأمنيات', 'error');
                    }
                }.bind(this))
                .fail(function() {
                    showToast('خطأ في الاتصال', 'error');
                });
        } else {
            // Add to wishlist
            $.post('@Url.Action("AddToWishlist", "Wishlist")', { productId: productId })
                .done(function(response) {
                    if (response.success) {
                        heartIcon.addClass('text-danger').css('color', '#dc3545');
                        $(this).html('<i class="fas fa-heart me-2 text-danger"></i>Remove from Wishlist');
                        showToast('تم إضافة المنتج إلى قائمة الأمنيات', 'success');
                        updateWishlistCount();
                    } else {
                        showToast('خطأ في إضافة المنتج إلى قائمة الأمنيات', 'error');
                    }
                }.bind(this))
                .fail(function() {
                    showToast('خطأ في الاتصال', 'error');
                });
        }
    });

    // Add to cart functionality
    $('.add-to-cart-btn').on('click', function(e) {
        e.preventDefault();
        
        const productId = $(this).data('product-id');
        const quantity = parseInt($('#quantity').val()) || 1;
        
        $.ajax({
            url: '@Url.Action("AddToCart", "Cart")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                ProductId: productId,
                Quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    showToast(response.message || 'تم إضافة المنتج إلى عربة التسوق بنجاح!', 'success');
                    updateCartCount();
                } else {
                    showToast(response.message || 'خطأ في إضافة المنتج إلى العربة', 'error');
                }
            },
            error: function() {
                showToast('خطأ في الاتصال', 'error');
            }
        });
    });

    // Related products wishlist functionality
    $('.wishlist-btn-related').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const productId = $(this).data('product-id');
        const heartIcon = $(this).find('i');
        const isInWishlist = heartIcon.hasClass('text-danger');
        
        if (isInWishlist) {
            // Remove from wishlist
            $.post('@Url.Action("RemoveFromWishlist", "Wishlist")', { productId: productId })
                .done(function(response) {
                    if (response.success) {
                        heartIcon.removeClass('text-danger').addClass('text-muted');
                        showToast('Product removed from wishlist', 'success');
                        updateWishlistCount();
                    } else {
                        showToast('Error removing product from wishlist', 'error');
                    }
                })
                .fail(function() {
                    showToast('Connection error', 'error');
                });
        } else {
            // Add to wishlist
            $.post('@Url.Action("AddToWishlist", "Wishlist")', { productId: productId })
                .done(function(response) {
                    if (response.success) {
                        heartIcon.removeClass('text-muted').addClass('text-danger');
                        showToast('Product added to wishlist', 'success');
                        updateWishlistCount();
                    } else {
                        showToast('Error adding product to wishlist', 'error');
                    }
                })
                .fail(function() {
                    showToast('Connection error', 'error');
                });
        }
    });

    // Load wishlist status for related products
    $('.wishlist-btn-related').each(function() {
        const productId = $(this).data('product-id');
        const heartIcon = $(this).find('i');
        
        $.get('@Url.Action("IsInWishlist", "Wishlist")', { productId: productId })
            .done(function(response) {
                if (response.isInWishlist) {
                    heartIcon.removeClass('text-muted').addClass('text-danger');
                }
            });
    });
});

// Function to load wishlist status for the product
function loadWishlistStatus() {
    const productId = $('.wishlist-btn').data('product-id');
    if (productId) {
        $.get('@Url.Action("IsInWishlist", "Wishlist")', { productId: productId })
            .done(function(response) {
                const heartIcon = $('.wishlist-btn').find('i');
                const button = $('.wishlist-btn');
                
                if (response.isInWishlist) {
                    heartIcon.addClass('text-danger').css('color', '#dc3545');
                    button.html('<i class="fas fa-heart me-2 text-danger"></i>Remove from Wishlist');
                } else {
                    heartIcon.removeClass('text-danger').css('color', '#ccc');
                    button.html('<i class="fas fa-heart me-2" style="color: #ccc;"></i>Add to Wishlist');
                }
            });
    }
}

// Function to update wishlist count in navigation
function updateWishlistCount() {
    $.get('@Url.Action("GetWishlistCount", "Wishlist")')
        .done(function(response) {
            $('#wishlist-count').text(response.count);
            if (response.count > 0) {
                $('#wishlist-count').show();
            } else {
                $('#wishlist-count').hide();
            }
        });
}

// Function to update cart count in navigation
function updateCartCount() {
    $.get('@Url.Action("GetCartCount", "Cart")')
        .done(function(response) {
            $('#cart-count').text(response.count);
            if (response.count > 0) {
                $('#cart-count').show();
            } else {
                $('#cart-count').hide();
            }
        });
}

// Function to show toast notifications
function showToast(message, type) {
    const toast = $('<div class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">')
        .addClass(type === 'success' ? 'bg-success' : 'bg-danger')
        .css({
            'position': 'fixed',
            'top': '20px',
            'right': '20px',
            'z-index': '9999'
        })
        .html(`
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `);
    
    $('body').append(toast);
    
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}
</script>
