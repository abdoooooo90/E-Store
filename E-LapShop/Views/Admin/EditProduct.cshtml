@using BLL.Models.ProductDtos
@model ProductUpdateDto
@{
    ViewData["Title"] = "تعديل المنتج";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-edit me-2"></i>تعديل المنتج</h2>
    <a href="@Url.Action("Products", "Admin")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="page-header">
    <form asp-action="EditProduct" method="post" enctype="multipart/form-data" id="editProductForm">
        <input asp-for="Id" type="hidden" />
        
        <div class="row">
            <!-- معلومات أساسية -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>المعلومات الأساسية</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="Name" class="form-label">اسم المنتج <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="أدخل اسم المنتج">
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryId" class="form-label">الفئة <span class="text-danger">*</span></label>
                                <select asp-for="CategoryId" class="form-select">
                                    <option value="">اختر الفئة</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <option value="@category.Id" selected="@(category.Id == Model.CategoryId)">@category.Name</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Price" class="form-label">السعر (ج.م) <span class="text-danger">*</span></label>
                                <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00">
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label asp-for="Description" class="form-label">الوصف</label>
                                <textarea asp-for="Description" class="form-control" rows="4" placeholder="أدخل وصف المنتج"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- المخزون والتوفر -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-warehouse me-2"></i>المخزون والتوفر</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="StockQuantity" class="form-label">الكمية المتاحة <span class="text-danger">*</span></label>
                                <input asp-for="StockQuantity" type="number" class="form-control" placeholder="0" min="0">
                                <span asp-validation-for="StockQuantity" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">حالة المنتج</label>
                                <div class="form-check form-switch">
                                    <input asp-for="IsAvailable" class="form-check-input" type="checkbox">
                                    <label asp-for="IsAvailable" class="form-check-label">متاح للبيع</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- إحصائيات المنتج -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-chart-bar me-2"></i>إحصائيات المنتج</h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <strong>0</strong>
                                            <br><small>مرات المشاهدة</small>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>0</strong>
                                            <br><small>مرات الإضافة للسلة</small>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>0</strong>
                                            <br><small>مرات البيع</small>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>0</strong>
                                            <br><small>التقييم</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الصور والمعاينة -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-images me-2"></i>صور المنتج</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">الصورة الحالية</label>
                            <div class="current-image mb-3">
                                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                                {
                                    <img src="@Model.ImageUrl" class="img-fluid rounded" style="max-height: 200px;" alt="صورة المنتج">
                                }
                                else
                                {
                                    <div class="image-preview">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                        <p class="text-muted mt-2">لا توجد صورة</p>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">تغيير الصورة</label>
                            <input type="file" class="form-control" accept="image/*" id="newImage" onchange="previewImage(this, 'newPreview')">
                            <div class="mt-3">
                                <div id="newPreview" class="image-preview" style="display: none;">
                                    <p class="text-muted mt-2">معاينة الصورة الجديدة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ImageUrl" class="form-label">رابط الصورة</label>
                            <input asp-for="ImageUrl" class="form-control" placeholder="https://example.com/image.jpg">
                            <small class="text-muted">يمكنك تعديل رابط الصورة</small>
                        </div>
                    </div>
                </div>

                <!-- إجراءات سريعة -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>إجراءات سريعة</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleAvailability()">
                                <i class="fas fa-toggle-on me-2"></i>تبديل التوفر
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="duplicateProduct()">
                                <i class="fas fa-copy me-2"></i>نسخ المنتج
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="viewProduct()">
                                <i class="fas fa-eye me-2"></i>عرض في المتجر
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- أزرار الحفظ -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <a href="@Url.Action("Products", "Admin")" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>إلغاء
                </a>
                <a href="@Url.Action("DeleteProduct", "Admin", new { id = Model.Id })" class="btn btn-outline-danger ms-2">
                    <i class="fas fa-trash me-2"></i>حذف المنتج
                </a>
            </div>
            <div>
                <button type="button" class="btn btn-outline-primary me-2" onclick="previewChanges()">
                    <i class="fas fa-eye me-2"></i>معاينة التغييرات
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>حفظ التغييرات
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
<script>
    // معاينة الصورة الجديدة
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;">`;
                preview.style.display = 'block';
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    // تبديل حالة التوفر
    function toggleAvailability() {
        const checkbox = document.querySelector('[name="IsAvailable"]');
        checkbox.checked = !checkbox.checked;
        
        const label = checkbox.nextElementSibling;
        label.textContent = checkbox.checked ? 'متاح للبيع' : 'غير متاح للبيع';
    }

    // معاينة التغييرات
    function previewChanges() {
        const name = document.querySelector('[name="Name"]').value;
        const price = document.querySelector('[name="Price"]').value;
        const description = document.querySelector('[name="Description"]').value;
        const isAvailable = document.querySelector('[name="IsAvailable"]').checked;
        const stock = document.querySelector('[name="StockQuantity"]').value;
        
        const previewHtml = `
            <div class="modal fade" id="changesPreview" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">معاينة التغييرات</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="bg-light p-4 text-center rounded">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                        <p class="mt-2 text-muted">صورة المنتج</p>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <h4>${name}</h4>
                                    <p class="text-success fs-5">${price} ج.م</p>
                                    <p class="text-muted">${description || 'لا يوجد وصف'}</p>
                                    <div class="mt-3">
                                        <span class="badge ${isAvailable ? 'bg-success' : 'bg-danger'} me-2">
                                            ${isAvailable ? 'متاح' : 'غير متاح'}
                                        </span>
                                        <span class="badge bg-info">الكمية: ${stock}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', previewHtml);
        const modal = new bootstrap.Modal(document.getElementById('changesPreview'));
        modal.show();
        
        document.getElementById('changesPreview').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // نسخ المنتج
    function duplicateProduct() {
        if (confirm('هل تريد إنشاء نسخة من هذا المنتج؟')) {
            const form = document.getElementById('editProductForm');
            const formData = new FormData(form);
            
            // تغيير الاسم لإضافة "نسخة من"
            const currentName = formData.get('Name');
            formData.set('Name', 'نسخة من ' + currentName);
            
            // إرسال البيانات لإنشاء منتج جديد
            window.location.href = '@Url.Action("CreateProduct", "Admin")';
        }
    }

    // عرض المنتج في المتجر
    function viewProduct() {
        // فتح المنتج في تبويب جديد
        window.open('/Furni/ProductDetails/@Model.Id', '_blank');
    }

    // التحقق من صحة النموذج
    document.getElementById('editProductForm').addEventListener('submit', function(e) {
        const name = document.querySelector('[name="Name"]').value.trim();
        const price = document.querySelector('[name="Price"]').value;
        const categoryId = document.querySelector('[name="CategoryId"]').value;
        const stockQuantity = document.querySelector('[name="StockQuantity"]').value;
        
        if (!name || !price || !categoryId || stockQuantity === '') {
            e.preventDefault();
            alert('يرجى ملء جميع الحقول المطلوبة');
            return false;
        }
        
        if (parseFloat(price) <= 0) {
            e.preventDefault();
            alert('يجب أن يكون السعر أكبر من صفر');
            return false;
        }
        
        if (parseInt(stockQuantity) < 0) {
            e.preventDefault();
            alert('يجب أن تكون الكمية صفر أو أكبر');
            return false;
        }
    });
</script>

<style>
    .image-preview {
        width: 100%;
        height: 200px;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .current-image img {
        border: 2px solid #dee2e6;
        border-radius: 8px;
    }
    
    .alert-info {
        background-color: #e7f3ff;
        border-color: #b8daff;
        color: #004085;
    }
</style>
}
