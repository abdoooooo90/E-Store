@using BLL.Models.ProductDtos
@model ProductCreateDto
@{
    ViewData["Title"] = "إضافة منتج جديد";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus me-2"></i>إضافة منتج جديد</h2>
    <a href="@Url.Action("Products", "Admin")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="page-header">
    <form asp-action="CreateProduct" method="post" enctype="multipart/form-data" id="createProductForm">
        <div class="row">
            <!-- معلومات أساسية -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>المعلومات الأساسية</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="Name" class="form-label">اسم المنتج <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="أدخل اسم المنتج" id="productName">
                                <span asp-validation-for="Name" class="text-danger"></span>
                                <div id="nameValidationMessage" class="mt-1"></div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoryId" class="form-label">الفئة <span class="text-danger">*</span></label>
                                <select asp-for="CategoryId" class="form-select">
                                    <option value="">اختر الفئة</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Price" class="form-label">السعر (ج.م) <span class="text-danger">*</span></label>
                                <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00">
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label asp-for="Description" class="form-label">الوصف</label>
                                <textarea asp-for="Description" class="form-control" rows="4" placeholder="أدخل وصف المنتج"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- المخزون والتوفر -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-warehouse me-2"></i>المخزون والتوفر</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="StockQuantity" class="form-label">الكمية المتاحة <span class="text-danger">*</span></label>
                                <input asp-for="StockQuantity" type="number" class="form-control" placeholder="0" min="0">
                                <span asp-validation-for="StockQuantity" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">حالة المنتج</label>
                                <div class="form-check form-switch">
                                    <input asp-for="IsAvailable" class="form-check-input" type="checkbox" checked>
                                    <label asp-for="IsAvailable" class="form-check-label">متاح للبيع</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الصور والمعاينة -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-images me-2"></i>صور المنتج</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">الصورة الرئيسية</label>
                            <input type="file" class="form-control" accept="image/*" id="mainImage" name="mainImage" onchange="previewImage(this, 'mainPreview')">
                            <div class="mt-3">
                                <div id="mainPreview" class="image-preview">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                    <p class="text-muted mt-2">معاينة الصورة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ImageUrl" class="form-label">رابط الصورة (اختياري)</label>
                            <input asp-for="ImageUrl" class="form-control" placeholder="https://example.com/image.jpg">
                            <small class="text-muted">يمكنك إدخال رابط صورة من الإنترنت</small>
                        </div>
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>إعدادات إضافية</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">الوزن (كجم)</label>
                            <input type="number" step="0.1" class="form-control" placeholder="0.0">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الأبعاد</label>
                            <div class="row">
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" placeholder="الطول">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" placeholder="العرض">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" placeholder="الارتفاع">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- أزرار الحفظ -->
        <div class="d-flex justify-content-between mt-4">
            <a href="@Url.Action("Products", "Admin")" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>إلغاء
            </a>
            <div>
                <button type="button" class="btn btn-outline-primary me-2" onclick="previewProduct()">
                    <i class="fas fa-eye me-2"></i>معاينة
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>حفظ المنتج
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
<script>
    // معاينة الصورة
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;">`;
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    // معاينة المنتج
    function previewProduct() {
        const name = document.querySelector('[name="Name"]').value;
        const price = document.querySelector('[name="Price"]').value;
        const description = document.querySelector('[name="Description"]').value;
        
        if (!name || !price) {
            alert('يرجى ملء الحقول المطلوبة أولاً');
            return;
        }
        
        const previewHtml = `
            <div class="modal fade" id="productPreview" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">معاينة المنتج</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="bg-light p-4 text-center rounded">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                        <p class="mt-2 text-muted">صورة المنتج</p>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <h4>${name}</h4>
                                    <p class="text-success fs-5">${price} ج.م</p>
                                    <p class="text-muted">${description || 'لا يوجد وصف'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', previewHtml);
        const modal = new bootstrap.Modal(document.getElementById('productPreview'));
        modal.show();
        
        // إزالة المودال بعد الإغلاق
        document.getElementById('productPreview').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // التحقق من صحة النموذج
    document.getElementById('createProductForm').addEventListener('submit', function(e) {
        const name = document.querySelector('[name="Name"]').value.trim();
        const price = document.querySelector('[name="Price"]').value;
        const categoryId = document.querySelector('[name="CategoryId"]').value;
        const stockQuantity = document.querySelector('[name="StockQuantity"]').value;
        
        if (!name || !price || !categoryId || !stockQuantity) {
            e.preventDefault();
            alert('يرجى ملء جميع الحقول المطلوبة');
            return false;
        }
        
        if (parseFloat(price) <= 0) {
            e.preventDefault();
            alert('يجب أن يكون السعر أكبر من صفر');
            return false;
        }
        
        if (parseInt(stockQuantity) < 0) {
            e.preventDefault();
            alert('يجب أن تكون الكمية صفر أو أكبر');
            return false;
        }
    });
</script>

<style>
    .image-preview {
        width: 100%;
        height: 200px;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .text-danger {
        font-size: 0.875em;
    }
    
    .name-exists {
        color: #dc3545;
        font-size: 0.875em;
    }
    
    .name-available {
        color: #198754;
        font-size: 0.875em;
    }
    
    .checking-name {
        color: #6c757d;
        font-size: 0.875em;
    }
</style>

<script>
$(document).ready(function() {
    let nameCheckTimeout;
    
    $('#productName').on('input', function() {
        const productName = $(this).val().trim();
        const messageDiv = $('#nameValidationMessage');
        
        // Clear previous timeout
        clearTimeout(nameCheckTimeout);
        
        if (productName.length < 2) {
            messageDiv.html('');
            return;
        }
        
        // Show checking message
        messageDiv.html('<i class="fas fa-spinner fa-spin me-1"></i><span class="checking-name">جاري التحقق من اسم المنتج...</span>');
        
        // Delay the check by 500ms to avoid too many requests
        nameCheckTimeout = setTimeout(function() {
            $.post('@Url.Action("CheckProductName", "Admin")', { 
                productName: productName 
            })
            .done(function(response) {
                if (response.exists) {
                    messageDiv.html('<i class="fas fa-times-circle me-1"></i><span class="name-exists">هذا الاسم موجود بالفعل، يرجى اختيار اسم آخر</span>');
                    $('#productName').addClass('is-invalid').removeClass('is-valid');
                } else {
                    messageDiv.html('<i class="fas fa-check-circle me-1"></i><span class="name-available">اسم المنتج متاح</span>');
                    $('#productName').addClass('is-valid').removeClass('is-invalid');
                }
            })
            .fail(function() {
                messageDiv.html('<i class="fas fa-exclamation-triangle me-1"></i><span class="text-warning">حدث خطأ في التحقق من الاسم</span>');
            });
        }, 500);
    });
    
    // Prevent form submission if name exists
    $('#createProductForm').on('submit', function(e) {
        const productName = $('#productName').val().trim();
        
        if (productName.length < 2) {
            e.preventDefault();
            alert('يرجى إدخال اسم المنتج');
            return false;
        }
        
        // Check if name exists before submitting
        $.post('@Url.Action("CheckProductName", "Admin")', { 
            productName: productName 
        })
        .done(function(response) {
            if (response.exists) {
                e.preventDefault();
                alert('اسم المنتج موجود بالفعل، يرجى اختيار اسم آخر');
                $('#productName').focus();
                return false;
            }
        });
    });
});
</script>
}
